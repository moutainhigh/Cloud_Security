<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cn.ctbri.entity.AlarmMapper">
	<!-- 列集合 -->
	<sql id="cols">id,name,alarm_time,level,advice,alarm_content,url,userId,taskId,alarm_type</sql>
	<!-- 结果对象 -->
	<resultMap type="com.cn.ctbri.entity.Alarm" id="Alarm">
		<id property="id" column="id"/>
		<result property="name" column="name"/>
		<result property="alarm_time" column="alarm_time"/>
		<result property="level" column="level"/>
		<result property="advice" column="advice"/>
		<result property="alarm_content" column="alarm_content"/>
		<result property="url" column="url"/>
		<result property="taskId" column="taskId"/>
		<result property="userId" column="userId"/>
		<result property="alarm_type" column="alarm_type"/>
	</resultMap>
	
	<!-- 插入报警信息 -->
	<insert id="insert" parameterType="com.cn.ctbri.entity.Alarm" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO cs_alarm 
		(name,alarm_time,level,advice,alarm_content,url,taskId,userId,alarm_type) 
		VALUES(#{name,jdbcType=VARCHAR},#{alarm_time,jdbcType=DATE},#{level},#{advice},#{alarm_content},#{url},#{taskId},#{userId},#{alarm_type})
	</insert>
	
	<!-- 查询报警信息  -->
	<select id="findAlarm" parameterType="map" resultMap="Alarm">
		select * from cs_alarm
		WHERE 1 = 1
		<if test="name != null">
			AND name like #{name}
		</if>
		<if test="taskId != null">
			AND taskId=#{taskId}
		</if>
		<if test="alarm_type != null">
			AND alarm_type=#{alarm_type}
		</if>
		<if test="level != null">
			AND level=#{level}
		</if>
	</select>
	<!-- 根据用户id查询告警数  -->
	<select id="findAlarmByUserId" parameterType="int" resultMap="Alarm">
		select * from cs_alarm
		where userId = #{userId}
	</select>
	<!-- 根据orderid查询告警数,最近告警信息  -->
    <select id="findAlarmByOrderId" resultMap="Alarm" parameterType="hashmap">
        select * from cs_alarm a,
		  (select t.taskId from cs_order_asset oa,cs_task t 
		    where oa.id = t.order_asset_id 
		    and oa.orderId=#{orderId}
		    and t.status = 3
		    order by t.execute_time desc
		    <if test="type==1">
             limit 0,1
            </if>) b
		where a.taskId = b.taskId 
		<if test="level!=null">
            and a.level=#{level}
        </if>
        order by a.level desc
    </select>
    <!-- 根据orderid和execute_time查询告警数,告警信息  dyy-->
    <select id="findAlarmByOrderIdAndExecute_time" resultMap="Alarm" parameterType="hashmap">	
        select * from cs_alarm a,
		  (select t.taskId from cs_order_asset oa,cs_task t 
		    where oa.id = t.order_asset_id 
		    and oa.orderId=#{orderId}
		    and t.status = 3
		    and t.execute_time = #{execute_time}
		    <if test="type==1">
             limit 0,1
            </if>) b
		where a.taskId = b.taskId 
		<if test="level!=null">
            and a.level=#{level}
        </if>
        order by a.level desc
    </select>
    	<!-- 根据orderid查询告警数,最近告警信息  -->
    <select id="findAlarmDdosByOrderId" resultType="com.cn.ctbri.entity.AlarmDDOS" parameterType="hashmap">
    select * from cs_alarmhuawei a
	where a.taskId =(select t.taskId from cs_order_ip op,cs_taskhuawei t 
		    where op.id = t.order_ip_id 
		    and op.orderId=#{orderId}
		    and t.status = 3
		    order by t.execute_time desc
		    )  and a.attack_type=#{type}
	order by a.alarm_time desc
    </select>
    
    
    <!-- 根据orderid查询任务数  -->
    <select id="findTaskByOrderId" resultType="com.cn.ctbri.entity.Task" parameterType="hashmap">
		select * from
	   (select * from cs_task t,cs_order_asset oa where oa.id = t.order_asset_id 
	    and oa.orderId=#{orderId} and t.status = 3 order by t.execute_time desc limit 0,7) a order by a.execute_time
    </select>
    
    <!-- 根据taskid查询告警数  -->
    <select id="findAlarmByTaskId" resultMap="Alarm" parameterType="hashmap">
        select * from cs_alarm a where a.taskId = #{taskId} and a.level = #{level}
    </select>
    
	<select id="findAll" resultMap="Alarm" parameterType="hashmap">
      	SELECT * FROM cs_alarm
    </select>		
	    <!-- 告警统计分析 -->	
	<select id="findAlarmByParam" resultMap="Alarm" parameterType="hashmap">
		SELECT b.alarm_type,COUNT(b.alarm_type) AS count
		FROM (
	      	SELECT a.alarm_type 
			FROM cs_alarm a 
			WHERE 1=1
			<if test="begin_datevo!=null">
				AND a.alarm_time &gt;= #{begin_datevo}
			</if>	 
			<if test="end_datevo!=null">
				AND a.alarm_time &lt;=#{end_datevo}
			</if>
			<if test="level!=null">
				AND a.level=#{level}
			</if>
			) b
		GROUP BY b.alarm_type    
    </select>	
    <!-- 告警统计分析 ：alarm_type不为空，levle为空-->	
    	<select id="findAlarmByParamAlarm_type" resultMap="Alarm" parameterType="hashmap">
			SELECT b.level, COUNT(b.level) as count
			FROM (
				SELECT a.alarm_type,a.level
				FROM cs_alarm a
				WHERE 1=1 and a.alarm_type = #{alarm_type}
				<if test="begin_datevo!=null">
					AND a.alarm_time &gt;= #{begin_datevo}
				</if>	 
				<if test="end_datevo!=null">
					AND a.alarm_time &lt;=#{end_datevo}
				</if>
				) b
			GROUP BY b.level   
    </select>	
    <!-- 告警统计分析 ：alarm_type不为空，levle不为空-->		
    <select id="findAlarmByParamAlarm_typeAndLevel" resultMap="Alarm" parameterType="hashmap">
    	SELECT b.name as alarm_type, COUNT(b.name) AS count
		FROM (
			SELECT a.alarm_type ,a.level,a.name 
			FROM cs_alarm a
			WHERE a.alarm_type = #{alarm_type} AND a.level=#{level}
			<if test="begin_datevo!=null">
				AND a.alarm_time &gt;= #{begin_datevo}
			</if>	 
			<if test="end_datevo!=null">
				AND a.alarm_time &lt;=#{end_datevo}
			</if>
			) b
		GROUP BY b.name
		ORDER BY  COUNT(b.name) DESC LIMIT 10
    </select>
</mapper>