<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cn.ctbri.entity.TaskMapper">
<sql id="cols">taskId,order_asset_Id,execute_time,status,remarks</sql>
	<resultMap type="com.cn.ctbri.entity.Task" id="TaskRM">
		<id property="taskId" column="taskId"/>
		<result property="order_asset_Id" column="order_asset_Id"/>
		<result property="execute_time" column="execute_time"/>
		<result property="status" column="status"/>
		<result property="remarks" column="remarks"/>
	</resultMap> 
	<!-- 根据订单资产id查询任务表 -->
	<select id="findTaskByOrderAssetId" parameterType="int" resultMap="TaskRM">
		 select * from cs_task where order_asset_Id=#{order_asset_Id}
	</select>
	
	<!-- 插入任务信息 -->
	<insert id="insert" parameterType="com.cn.ctbri.entity.Task" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO cs_task
		(order_asset_Id,execute_time,status,remarks) 
		VALUES( #{order_asset_Id} , #{execute_time},#{status},#{remarks})
	</insert>
	<!-- 根据orderId查询扫描次数 -->
	<select id="findByOrderId" parameterType="int" resultType="Object">
		SELECT a.id ,COUNT(a.id)	
		FROM	
			(SELECT o.id ,t.taskId
			FROM cs_order o, cs_order_asset oa, cs_task t
			WHERE o.id={id} AND oa.id=t.order_asset_Id)a
		GROUP BY a.id HAVING a.id={id}
	</select>
	
		<!-- 根据orderId查询扫描进度和最近的url-->
	<select id="findProgressByOrderId" parameterType="String" resultMap="TaskRM">
		<!-- SELECT AVG(t.taskProgress)/101*100 AS COUNT
				FROM cs_task t
				WHERE t.order_asset_Id IN (
					SELECT oa.id
					FROM cs_order_asset oa
					WHERE oa.orderId =#{orderId}) -->
			
			SELECT a.count,b.currentUrl
			FROM
					(SELECT AVG(t.taskProgress)/101*100 AS COUNT
					FROM cs_task t
					WHERE t.order_asset_Id IN (
						SELECT oa.id
						FROM cs_order_asset oa
						WHERE oa.orderId =#{orderId})) a
			CROSS JOIN
					(SELECT t.currentUrl
					FROM cs_task t
					WHERE t.order_asset_Id IN (
						SELECT oa.id
						FROM cs_order_asset oa
						WHERE oa.orderId =#{orderId})
					ORDER BY t.execute_time DESC LIMIT 0,1) b
	</select>
	<!-- 根据orderId查询基本信息 -->
	<select id="findBasicInfoByOrderId" parameterType="String" resultMap="TaskRM">
		SELECT MIN(t.begin_time) AS begin_time,MAX(t.end_time) AS end_time,AVG(t.scanTime) AS scanTime,AVG(t.issueCount) AS issueCount,AVG(t.requestCount) AS requestCount,AVG(t.urlCount) AS urlCount,AVG(t.averResponse) AS averResponse,AVG(t.averSendCount) AS averSendCount,AVG(t.sendBytes) AS sendBytes,AVG(t.receiveBytes) AS receiveBytes
		FROM cs_task t
		WHERE t.order_asset_Id IN (
			SELECT oa.id 
			FROM cs_order_asset oa
			WHERE oa.orderId=#{orderId})
		ORDER BY t.begin_time DESC 	
	</select>
	<!-- 根据orderId查询历史详情时间 -->
	<select id="findScanTimeByOrderId" parameterType="String" resultMap="TaskRM">
		SELECT t.execute_time 
		FROM cs_task t
		WHERE t.order_asset_Id IN (
			SELECT oa.id 
			FROM cs_order_asset oa
			WHERE oa.orderId=#{orderId})
		ORDER BY t.begin_time DESC 	
	</select>	
</mapper>